name: build test

on:
  push:
    paths-ignore:
      - '*.md'
  pull_request:
    branches: [ master ]

jobs:
  build-macos:
    name: Build FFmpeg for macOS 15 (M1/Apple Silicon)
    runs-on: macos-15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build FFmpeg
        run: |
          # 开启 GPL 和非免费插件以获得最大编解码支持
          # SKIPINSTALL=yes 防止脚本尝试执行 sudo 安装操作
          # VERBOSE=yes 方便出错时排查日志
          SKIPINSTALL=yes VERBOSE=yes ./build-ffmpeg --build --enable-gpl-and-non-free

      - name: Check binary info
        run: |
          # 验证是否为 Apple Silicon (arm64) 架构以及链接库情况
          file ./workspace/bin/ffmpeg
          otool -L ./workspace/bin/ffmpeg
          ./workspace/bin/ffmpeg -version

      - name: Upload FFmpeg Binary
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-macos-m1-static
          path: workspace/bin
